import 'dotenv/config'
import { Test, TestingModule } from '@nestjs/testing'
import { RhinestoneService } from './rhinestone.service'
import { RhinestoneRelayerActionV1 } from '../types/rhinestone-websocket.types'
import { RhinestoneValidatorService } from './rhinestone-validator.service'
import { RhinestoneStandaloneModule } from '@/rhinestone/standalone/rhinestone-standalone.module'
import { FeeService } from '@/fee/fee.service'
import { KmsService } from '@/kms/kms.service'
import { SignerKmsService } from '@/sign/signer-kms.service'

describe('RhinestoneService', () => {
  let service: RhinestoneService
  let feeService: FeeService
  let kmsService: KmsService
  let signerKmsService: SignerKmsService
  let rhinestoneValidatorService: RhinestoneValidatorService

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [RhinestoneStandaloneModule],
    }).compile()

    service = module.get<RhinestoneService>(RhinestoneService)
    feeService = module.get<FeeService>(FeeService)
    kmsService = module.get<KmsService>(KmsService)
    signerKmsService = module.get<SignerKmsService>(SignerKmsService)
    rhinestoneValidatorService = module.get<RhinestoneValidatorService>(RhinestoneValidatorService)

    feeService.onModuleInit()
    await kmsService.onModuleInit()
    await signerKmsService.onModuleInit()

    // Mock logger methods
    jest.spyOn(service['logger'], 'log').mockImplementation()
    jest.spyOn(service['logger'], 'error').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'log').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'error').mockImplementation()
  })

  describe('handleRelayerAction', () => {
    it('should handle RelayerActionV1 message without throwing', async () => {
      const message: RhinestoneRelayerActionV1 = {
        type: 'RelayerActionV1' as any,
        id: '4615240745536916175579783205594751135263443991473522628107802029291691048960',
        timestamp: 1755797833,
        fill: {
          id: 0,
          call: {
            chainId: 8453,
            data: '0xdf2c9057000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf090000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006a42736b82700000000000000000000000000000000000000000000000000000000000001000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000005600a3422399a3c9b85b2ca9b930f39e471aa26560c40796d634405800000000000000000000000000000000000000000000000000000000000000000006a888cc8000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000804fa18a80797242f64d9f411c3e69b5f62deae800a2e380d48d86b5813ae3fc090fdf5f78c89c6377b0059d80e40bf3300486791614f455f352092f0352bd79720000000000000000000000000f124aa8f92f47302fcba08b7349aefee853ed8d0a3422399a3c9b85b2ca9b930f39e471aa26560c40796d634405800000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000210500000000000000000000000004c816032a076df65b411bb3f31c8d569d411ee200000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9b2267f9cf08a861a749716d265d2a19dc0ccac4262bfe47b95a26e6c500ebf3332ec579f84ddfb1153ecf4d79aa18906674a17a04167ec1196cee32b65afbbf71c00000000000000000000000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000316c3a65367e86b467f9cd4036fba5ed61a75be462046256dd2b28001b63a6d4e5a9c13c15efad62d8af6928cbe413cf2efa056a6d7cdc4f0accebcb82a7a7ac1a73b370ea3b78d54ec6511d76b487ddcd690b13c26829342e733ad8539893080000000000000000000000000000000000000000000000000000000068a75a740000000000000000000000000000000000000000000000000000000000002105794ca8af03b44271b49c46e3a22d5d8d623c5fad6caeb6c24136fb625fd6160c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ed20610baaea6bb1c82f4db8e57c83b58e569c0f7d307557afebf5571a192c576db70b7200620af59ca5a5e9e011e25cc07a881487ffa45e5477fa43c71bd9b11c00000000000000000000000000000000000000000000000000000000000000',
            to: '0x000000000004598d17aad017bf0734a364c5588b',
            value: '0',
          },
        },
        claims: [
          {
            id: 0,
            call: {
              chainId: 10,
              data: '0x0fbb12dc000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf090000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000009c4c4d3b5160000000000000000000000000000000000000000000000000000000000000020893c0175b322c202ac01ba29d75e22c510985684e8cf31733adb2f84a0cb0f4d00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000092000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80a3422399a3c9b85b2ca9b930f39e471aa26560c40796d634405800000000000000000000000000000000000000000000000000000000000000000006a888cc80000000000000000000000000000000000000000000000000000000068a75a74000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000002105000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000000000000000000000000000000000000001604d77233809dc2ee22928c60b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000001a4790000000000000000000000000000000000000000000000000000000000000001604d77233809dc2ee22928c6833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002810300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b300000000000000000000000073d2dc0c21fca4ec1601895d50df7f5624f07d3f000000000000000000000000000000000000000000000000000000000001a4790000000000000000000000000000000000000000000000000000000000000000000000000000000073d2dc0c21fca4ec1601895d50df7f5624f07d3f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000848fa31b580000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85604d77233809dc2ee22928c60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a4790000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014103000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004804c816032a076df65b411bb3f31c8d569d411ee20f124aa8f92f47302fcba08b7349aefee853ed8d0a3422399a3c9b85b2ca9b930f39e471aa26560c40796d634405800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9b2267f9cf08a861a749716d265d2a19dc0ccac4262bfe47b95a26e6c500ebf3332ec579f84ddfb1153ecf4d79aa18906674a17a04167ec1196cee32b65afbbf71c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000417c8cf29184373fdc56b56e1ad2566d72d2825194525a4d27bfa51441f0d7912b1cf0f2c839cc9df2e9243ce5ed9bc9c84299b9ac605d8e663525e25ddd2249ff1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
              to: '0x000000000004598d17aad017bf0734a364c5588b',
              value: '0',
            },
            beforeFill: true,
            settlementLayer: 'ECO',
          },
        ],
      } as const

      // The handleRelayerAction doesn't throw - it catches errors internally
      await service.handleRelayerAction(message)
    })
  })
})
