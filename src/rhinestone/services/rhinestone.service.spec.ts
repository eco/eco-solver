import 'dotenv/config'
import { Test, TestingModule } from '@nestjs/testing'
import { RhinestoneService } from './rhinestone.service'
import { RhinestoneRelayerActionV1 } from '../types/rhinestone-websocket.types'
import { RhinestoneValidatorService } from './rhinestone-validator.service'
import { RhinestoneStandaloneModule } from '@/rhinestone/standalone/rhinestone-standalone.module'
import { FeeService } from '@/fee/fee.service'
import { KmsService } from '@/kms/kms.service'
import { SignerKmsService } from '@/sign/signer-kms.service'

describe('RhinestoneService', () => {
  let service: RhinestoneService
  let feeService: FeeService
  let kmsService: KmsService
  let signerKmsService: SignerKmsService
  let rhinestoneValidatorService: RhinestoneValidatorService

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [RhinestoneStandaloneModule],
    }).compile()

    service = module.get<RhinestoneService>(RhinestoneService)
    feeService = module.get<FeeService>(FeeService)
    kmsService = module.get<KmsService>(KmsService)
    signerKmsService = module.get<SignerKmsService>(SignerKmsService)
    rhinestoneValidatorService = module.get<RhinestoneValidatorService>(RhinestoneValidatorService)

    feeService.onModuleInit()
    await kmsService.onModuleInit()
    await signerKmsService.onModuleInit()

    // Mock logger methods
    jest.spyOn(service['logger'], 'log').mockImplementation()
    jest.spyOn(service['logger'], 'error').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'log').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'error').mockImplementation()
  })

  describe('handleRelayerAction', () => {
    it('should handle RelayerActionV1 message without throwing', async () => {
      const message: RhinestoneRelayerActionV1 = {
        type: 'RelayerActionV1' as any,
        id: '4760251234823897175511653314879241977633990726741257249106848982678525444096',
        timestamp: 1755116534,
        fill: {
          id: 0,
          call: {
            chainId: 137,
            data: '0xdf2c9057000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000d4000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004bc9280836c4e1dcf7ad4e460cfd30791ccc4f9c8a4f820ec671688f0b900000000000000000000000029fcb43b46531bca003ddc8fcb67ffe91900c762000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000eb0000000000000000000000000000000000000000000000000000000000000404b63e800d0000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000075798463024bda64d83c94a64bc7d7eab41300ef00000000000000000000000000000000000000000000000000000000000001400000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000df21fc5dde6ffafe08b5df2a7ecc416f7527a07000000000000000000000000000000000000000000000000000000000000028447cbbdca0000000000000000000000007579f2ad53b01c3d8779fe17928e0d48885b00030000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000e9e6e96bcaa3c113187cdb7e38aed90000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000df21fc5dde6ffafe08b5df2a7ecc416f7527a0700000000000000000000000000000000005ad9ce1f5035fd62ca96cef16adaaf000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a42736b82700000000000000000000000000000000000000000000000000000000000001000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000005600a8634eb971b67bd822f32f61dde58dd211ca4b72271e84ed676000000000000000000000000000000000000000000000000000000000000000000006a7e277500000000000000000000000000000000000000000000000000000000000021050000000000000000000000000000000000000000000000000000000000000080e16ec726ee46945db1e1774dd111b7d828312221aa6366419af43790af6a6a9f1ac3e92668c797d8827e2da69a1bda44f1f1dbc04726abd6647444b9d2dca2df000000000000000000000000b4b22bafafc0fe12bc9be00d6611dd2d8a42a7a80a8634eb971b67bd822f32f61dde58dd211ca4b72271e84ed6760000000000000000000000000000000000000000000000000000000000000000000000002105000000000000000000000000000000000000000000000000000000000000008900000000000000000000000004c816032a076df65b411bb3f31c8d569d411ee200000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000010000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c3359000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c3359000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9ba1467018641e13274722bb85b7c3e96e170560302e5614da441cc590a8566977a9dae465e0bfebb23720443632259a4617ba8f69b6312b7751d46029d46aea71b00000000000000000000000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba8000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000007f7b10938b6cc61e31261b058b863821fd13b1278df1c2e0cc385f7a010586792e18f96ec1fb46d60afbc6d5abd28456f7d02194b66cec4e47c108f46dabb9427363f26af6e1353562136271fbc2bcb94a1faf8607dcc51adbc45191e318124000000000000000000000000000000000000000000000000000000000689cf52100000000000000000000000000000000000000000000000000000000000000897c20d1347979cd3787dc71464a9302df6b952a61b7ae1150ccf6c239652ab2980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041b5f881c87f1a249c712c41728bb3799e0aacb33c1e13921ea113eaae2a432d0c557c3d5faf317a22aa2179987d310358db25e33d570c092e09a5556e8224d1551c00000000000000000000000000000000000000000000000000000000000000',
            to: '0x000000000004598d17aad017bf0734a364c5588b',
            value: '0',
          },
        },
        claims: [
          {
            id: 0,
            call: {
              chainId: 8453,
              data: '0x0fbb12dc000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf090000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000009c4c4d3b516000000000000000000000000000000000000000000000000000000000000002079ed03f0cde10b04dd9eb65eed166ba5c1a2f82a468c9bf734587365c5dccd8100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000092000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80a8634eb971b67bd822f32f61dde58dd211ca4b72271e84ed676000000000000000000000000000000000000000000000000000000000000000000006a7e277500000000000000000000000000000000000000000000000000000000689cf52100000000000000000000000000000000000000000000000000000000000021050000000000000000000000000000000000000000000000000000000000000089000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000000000000000000000000000000000000001604d77233809dc2ee22928c6833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000000000000021c560000000000000000000000000000000000000000000000000000000000000001604d77233809dc2ee22928c63c499c542cef5e3811e1192ce70d8cc03d5c335900000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000281030000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b300000000000000000000000073d2dc0c21fca4ec1601895d50df7f5624f07d3f0000000000000000000000000000000000000000000000000000000000021c560000000000000000000000000000000000000000000000000000000000000000000000000000000073d2dc0c21fca4ec1601895d50df7f5624f07d3f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000848fa31b58000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913604d77233809dc2ee22928c600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021c560000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000141030000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003c499c542cef5e3811e1192ce70d8cc03d5c3359000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004804c816032a076df65b411bb3f31c8d569d411ee2b4b22bafafc0fe12bc9be00d6611dd2d8a42a7a80a8634eb971b67bd822f32f61dde58dd211ca4b72271e84ed676000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9ba1467018641e13274722bb85b7c3e96e170560302e5614da441cc590a8566977a9dae465e0bfebb23720443632259a4617ba8f69b6312b7751d46029d46aea71b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ab1453d450b2eb39de7f40084b42f10846c76b548230eeed5ac0218dfc14226c420ae0140581ab8122ba3fa5a88ae7f9b5fb790765b92c34fe7e22f014e776b01b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
              to: '0x000000000004598d17aad017bf0734a364c5588b',
              value: '0',
            },
            beforeFill: true,
            settlementLayer: 'ECO',
          },
        ],
      } as const

      // The handleRelayerAction doesn't throw - it catches errors internally
      await service.handleRelayerAction(message)
    })
  })
})
