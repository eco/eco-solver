import 'dotenv/config'
import { Test, TestingModule } from '@nestjs/testing'
import { RhinestoneService } from './rhinestone.service'
import { RhinestoneRelayerActionV1 } from '../types/rhinestone-websocket.types'
import { RhinestoneValidatorService } from './rhinestone-validator.service'
import { RhinestoneStandaloneModule } from '@/rhinestone/standalone/rhinestone-standalone.module'
import { FeeService } from '@/fee/fee.service'
import { KmsService } from '@/kms/kms.service'
import { SignerKmsService } from '@/sign/signer-kms.service'

describe('RhinestoneService', () => {
  let service: RhinestoneService
  let feeService: FeeService
  let kmsService: KmsService
  let signerKmsService: SignerKmsService
  let rhinestoneValidatorService: RhinestoneValidatorService

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [RhinestoneStandaloneModule],
    }).compile()

    service = module.get<RhinestoneService>(RhinestoneService)
    feeService = module.get<FeeService>(FeeService)
    kmsService = module.get<KmsService>(KmsService)
    signerKmsService = module.get<SignerKmsService>(SignerKmsService)
    rhinestoneValidatorService = module.get<RhinestoneValidatorService>(RhinestoneValidatorService)

    feeService.onModuleInit()
    await kmsService.onModuleInit()
    await signerKmsService.onModuleInit()

    // Mock logger methods
    jest.spyOn(service['logger'], 'log').mockImplementation()
    jest.spyOn(service['logger'], 'error').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'log').mockImplementation()
    jest.spyOn(rhinestoneValidatorService['logger'], 'error').mockImplementation()
  })

  describe('handleRelayerAction', () => {
    it('should handle RelayerActionV1 message without throwing', async () => {
      const message: RhinestoneRelayerActionV1 = {
        type: 'RelayerActionV1' as any,
        id: '4094756175101129175405794112826128583058863187909293516803719673745619550208',
        timestamp: 1754057941,
        fill: {
          id: 0,
          call: {
            chainId: 8453,
            data: '0xdf2c9057000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000920000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014e59aaf21c4d9cf92d9ed4537f4404ba031f83b230000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007c426c43cab00000000000000000000000000000000000000000000000000000000000001000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000660090d8cc3e70a81eb8eba2eb87bc99713e67103f2f18612adef74000000000000000000000000000000000000000000000000000000000000000000006a6e0055000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000080a661332dfeb186340cecdbd11a5f2430589f4e3db5dabb70009ff296b1dd0de4d9fac976f5bdf3af212864506aa322b32653219991e781ca1b026765d44611ab000000000000000000000000b39dca629be804b9e0ec7e6a7802f94f6a7cbb89090d8cc3e70a81eb8eba2eb87bc99713e67103f2f18612adef74000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000021050000000000000000000000000746dc2cdcbf6270c9c53d1c4923604448cf3e9400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004598d17aad017bf0734a364c5588b0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000449f3606486dad613afc13fe4e925fc694e84c5853ad5bb8b0f8829c498a110935083a35b20000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9142ba45745ec5cea8bb3154cfd158f5e91653ac8dc397f5070438b48326db10e7df3c94335d3e83db9709a50c7fa57a4b3addafb6386d1218cfd33d30b17c17f1c00000000000000000000000000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80000000000000000000000000746dc2cdcbf6270c9c53d1c4923604448cf3e94000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000002ee380a0d1fb770cf943f219b95b5ab62d26c5c6547724904eac9cc91148d2a6a03225140c5bb5d2371c2835f1707523b1f70bbfae17e63d228284892ada785b1a73b370ea3b78d54ec6511d76b487ddcd690b13c26829342e733ad85398930800000000000000000000000000000000000000000000000000000000688cce010000000000000000000000000000000000000000000000000000000000002105966d5cc140c4d7045a4dbd94ccb69fe819523fc41a8f0d6e2d0a7adfaef7a6e60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041fe0595c9855431d568015320578dd4b145b1a07ee8c4dd3a5084a3eb2aeb623676e409d7857f04aa0b815b1763184780f695a09f682e9d0f7883c2884b6d078f1b00000000000000000000000000000000000000000000000000000000000000',
            to: '0x000000000004598d17aad017bf0734a364c5588b',
            value: '0',
          },
        },
        claims: [
          {
            id: 0,
            call: {
              chainId: 10,
              data: '0x0fbb12dc000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014e59aaf21c4d9cf92d9ed4537f4404ba031f83b230000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000009c4c4d3b51600000000000000000000000000000000000000000000000000000000000000206dad613afc13fe4e925fc694e84c5853ad5bb8b0f8829c498a110935083a35b200000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000092000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba80000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba8090d8cc3e70a81eb8eba2eb87bc99713e67103f2f18612adef74000000000000000000000000000000000000000000000000000000000000000000006a6e005500000000000000000000000000000000000000000000000000000000688cce01000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000002105000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f70b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000002213d000000000000000000000000000000000000000000000000000000000000000160d3efd0fdef3b05df2e05f7833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000002810300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000abd3388a633758d0bae01efb885ef1e87bd519a6000000000000000000000000000000000000000000000000000000000002213d00000000000000000000000000000000000000000000000000000000000000000000000000000000abd3388a633758d0bae01efb885ef1e87bd519a60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000848fa31b580000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff8560d3efd0fdef3b05df2e05f70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002213d0000000000000000000000007931f6056c075752131d3a06e825a21fedec9ba800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000014103000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000256b70644f5d77bc8e2bb82c731ddf747ecb147100000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000480746dc2cdcbf6270c9c53d1c4923604448cf3e94b39dca629be804b9e0ec7e6a7802f94f6a7cbb89090d8cc3e70a81eb8eba2eb87bc99713e67103f2f18612adef74000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000550000000000e9e6e96bcaa3c113187cdb7e38aed9142ba45745ec5cea8bb3154cfd158f5e91653ac8dc397f5070438b48326db10e7df3c94335d3e83db9709a50c7fa57a4b3addafb6386d1218cfd33d30b17c17f1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004147d0f578034da21e450daaa61af0f4c7870250b2b2eb4307989a75bc20b893ab15eed10557eb4b178777c70f994e96665ae460498d7ab876a2b6b88092ef7b001b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
              to: '0x000000000004598d17aad017bf0734a364c5588b',
              value: '0',
            },
            beforeFill: true,
            settlementLayer: 'ECO',
          },
        ],
      } as const

      // The handleRelayerAction doesn't throw - it catches errors internally
      await service.handleRelayerAction(message)
    })
  })
})
