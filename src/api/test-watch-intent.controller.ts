import { Controller, Post, Logger } from '@nestjs/common'
import { ApiTags } from '@nestjs/swagger'
import { WatchCreateIntentService } from '@/watch/intent/watch-create-intent.service'
import { EcoLogMessage } from '@/common/logging/eco-log-message'
import { API_ROOT, TEST_ROUTE } from '@/common/routes/constants'

@ApiTags('Testing')
@Controller(API_ROOT + TEST_ROUTE)
export class TestWatchIntentController {
  private readonly logger = new Logger(TestWatchIntentController.name)

  constructor(private readonly watchCreateIntentService: WatchCreateIntentService) {}

  @Post('/watch-intent')
  async testWatchIntent() {
    this.logger.log(
      EcoLogMessage.fromDefault({
        message: 'Received test intent event for processing',
        properties: { eventData },
      }),
    )
    const mockSource = {
      chainID: 10n,
      network: 'ethereum' as any, // You might want to derive this from chainID
      // Create a mock IntentSource configuration for testing
    } as any
    // Get the addJob function with the mock source
    const addJobFunction = this.watchCreateIntentService.addJob(mockSource)

    // Process the log through the service pipeline
    await addJobFunction(eventData as any)
  }
}

const eventData = [
  {
    eventName: 'IntentCreated',
    args: {
      hash: '0xf12e049e7f021566fdf4c6dc1cb3cf0841e5b45368dcd457076f5fea2fb073d7',
      creator: '0xfc79413b46256405819A32Fb25A9B6Dd9A911559',
      prover: '0x06A931CC393692eC523E413e341A00fe6C801824',
      salt: '0x6222225e16e65eb36e43ec1ab6adb63750fb3722c8c21eaf14f2bb5d62da5aa0',
      source: 10n,
      destination: 8453n,
      inbox: '0xE02A17467Df7b1950C8849dA226844e5d3Db781a',
      routeTokens: [
        {
          token: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
          amount: 750000n,
        },
      ],
      calls: [
        {
          target: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
          data: '0xa9059cbb000000000000000000000000fc79413b46256405819a32fb25a9b6dd9a91155900000000000000000000000000000000000000000000000000000000000b71b0',
          value: 0n,
        },
      ],
      deadline: 1754949908n,
      nativeValue: 0n,
      rewardTokens: [
        {
          token: '0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85',
          amount: 1125000n,
        },
      ],
    },
    address: '0x17683c781adb1cd185b08041da61b02a2df65538',
    blockHash: '0xa158dad8d1214bd4a6eecbc80119d147d6e113ae719748113e1799523211ad25',
    blockNumber: 139672880n,
    data: '0x6222225e16e65eb36e43ec1ab6adb63750fb3722c8c21eaf14f2bb5d62da5aa0000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000002105000000000000000000000000e02a17467df7b1950c8849da226844e5d3db781a0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000689a6914000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000b71b000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000fc79413b46256405819a32fb25a9b6dd9a91155900000000000000000000000000000000000000000000000000000000000b71b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000000000000000000000000000000112a88',
    logIndex: 0,
    removed: false,
    topics: [
      '0xd802f2610d0c85b3f19be4413f3cf49de1d4e787edecd538274437a5b9aa648d',
      '0xf12e049e7f021566fdf4c6dc1cb3cf0841e5b45368dcd457076f5fea2fb073d7',
      '0x000000000000000000000000fc79413b46256405819a32fb25a9b6dd9a911559',
      '0x00000000000000000000000006a931cc393692ec523e413e341a00fe6c801824',
    ],
    transactionHash: '0xf0b32ca040107de562308d4ad0e5301fd41893e91fd6f8820b13af782773045c',
    transactionIndex: 1,
  },
]
