# Receipt Logging Enhancement Plan

## Objective

Enhance the automatic logging system to include transaction receipt data in the structured logs generated by the `@LogOperation` decorator.

## Current State

- The `fulfill` method in `WalletFulfillService` gets a transaction receipt from `kernelAccountClient.waitForTransactionReceipt()`
- The receipt is stored in `model.receipt` but not automatically included in decorator-based logs
- Receipt data is only captured in explicit analytics calls (`trackIntentFulfillmentSuccess`, etc.)
- The `@LogContext` decorators can only extract context from method parameters, not internal variables

## Solution: Enhance IntentContext Extractor

### Approach

Modify the `extractIntentContext` function in `context-extractors.ts` to read receipt data from the `model.receipt` field when available.

### Analysis Results

### Receipt Storage Locations

1. **`wallet-fulfill.service.ts:92`** - Success case: `model.receipt = receipt as any`
2. **`wallet-fulfill.service.ts:105`** - Error case: `model.receipt = model.receipt ? { previous: model.receipt, current: e } : e`
3. **`utils-intent.service.ts:76`** - Invalid case: `model.receipt = invalidCause as any`
4. **`utils-intent.service.ts:92`** - Infeasible case: `model.receipt = infeasable as any`

### Receipt Object Types

1. **Transaction Receipt** (success case)
   - `transactionHash`: string
   - `blockNumber`: bigint
   - `blockHash`: string
   - `gasUsed`: bigint
   - `gasPrice`/`effectiveGasPrice`: bigint
   - `status`: 'success' | 'reverted'
   - `logs`: Array of event logs
   - `cumulativeGasUsed`: bigint
   - `transactionIndex`: number

2. **ValidationChecks Object** (invalid case)
   - `supportedProver`: boolean
   - `supportedNative`: boolean
   - `supportedTargets`: boolean
   - `supportedTransaction`: boolean
   - `validTransferLimit`: boolean
   - `validExpirationTime`: boolean
   - `validDestination`: boolean
   - `fulfillOnDifferentChain`: boolean
   - `sufficientBalance`: boolean

3. **Error Object** (infeasible/failed cases)
   - Standard Error properties: `name`, `message`, `stack`
   - May contain additional properties depending on error type

4. **Nested Receipt** (failed after previous attempt)
   - `previous`: any previous receipt object
   - `current`: current error object

## Implementation Steps

2. **Enhance extractIntentContext Function**
   - Add receipt detection logic to `extractIntentContext`
   - Handle different receipt object types (success receipts vs error objects)
   - Extract relevant fields for logging (transaction_hash, block_number, gas_used, status, etc.)
   - Safely handle missing or malformed receipt data

3. **Add Type Guards**
   - Create helper functions to identify receipt types
   - Distinguish between transaction receipts and error objects
   - Handle nested receipt structures (e.g., `{previous: receipt, current: error}`)

### Expected Outcome

- Transaction receipt data automatically appears in decorator-generated logs
- Structured logging includes transaction_hash, block_number, gas_used, status
- Works for both successful and failed transaction scenarios
- No changes required to method signatures or manual logging calls

### Benefits

- Consistent receipt logging across all `@LogOperation` decorated methods
- Better observability for transaction execution
- Automatic inclusion in structured log context
- Maintains existing analytics logging as backup
