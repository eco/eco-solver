import { Hex } from 'viem'

import { decodeAdapterClaim } from './src/modules/rhinestone/utils/decoder'
import { extractIntent } from './src/modules/rhinestone/utils/intent-extractor'
import { unpadFrom32Bytes } from './src/common/types/universal-address.type'

const sampleIntent = {
  type: 'RelayerAction',
  messageId: '1',
  action: {
    type: 'RelayerActionV1',
    id: '4872511886242711762213558043176787997797713153793066627272501151238706954240',
    timestamp: 1762213558,
    fill: {
      call: {
        chainId: 42161,
        to: '0x000000000004598d17aad017bf0734a364c5588b',
        data: '0x00000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000d20000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf090000000000000000000000000000000000000000000000000000000000000000000000000000000000000c200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000003bc9280836c0000000000679a258c64d2f20f310e12b64b7375ea6d13ac0000000000000000000000000000000000000000000000000000000000000040c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000006efb61d8c9546ff1b500de3f244ea7000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002c441bede0300000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000062b2ac83e0c8666d9be4e75b99c0e96c822d23e100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000005ad9ce1f5035fd62ca96cef16adaaf0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003041c1e7c17000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000005eeb0df30c63390735645a0788a373550ebd57073d704f7a3e25f698fbd0f640f8858e1659fe836cf8866da44a48b8b6e4f3229410d3811d7571270399f8bb98d01e28b32a455f66a5f699d3fa595be9e271c7160ac5be7693d6687686ea2c5a08abbc12d71c2a685d07c3d982db000000000000a08e685f6f5ce093eec4d47ad2a84b31ffe4c7f8e55cbda2cd611b5c7902c3ff0000000000000000000000000000000000000000000000000000000069093fe2000000000000000000000000399dbd5df04f83103f77a58cba2b7c4d3cdede97000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000c35000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000005eeb0df30c63390735645a0788a373550ebd5707000000000000000000000000000000000000000000000000000000000000c3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042426848633000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000005eeb0df30c63390735645a0788a373550ebd57070ac5be7693d6687686ea2c5a08abbc12d71c2a685d07c3d982db0000000000000000000000000000000000000000000000000000000000000000000069093fe20000000000000000000000005eeb0df30c63390735645a0788a373550ebd570700000000000000000000000056ac608c6edc0500163f1e6f059f9f6cdf2e843d00000000000000000000000000000000000000000000000000000000000021058c8c351b1aa1de46d94aa05dcc13ff8a2edb786fb6eee5ec793880f50e45653d564f3b0be0b0ed05e461d7430ccd7912841d278bac037b527825ccf47ec3bcf770a2ba1284b6cb61a892a5fbc6782dd8f82db0e85e1c410d97969e043712e13340167022a18fb9a9d17e45d9dcfb8f4583d29c78df5c51daf8f8aaff048a9fd10000000000000000000000000000000000000000000000000000000069093fe2cc69ac819e2d6a63a8ada61598c19285c4d1f5e1fd7699563ec12d8f0bb7598e00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001420304000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000062b2ac83e0c8666d9be4e75b99c0e96c822d23e1000000000000000000000000000000000000000000000000000000000000c3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000550000000000000000000000000000000000000000dc747d38e52808556101dd05e53ad363e7e7b2906431f2a1141daf86ca87a86e58cd169d3ca6da7ef9f8551cb819e84fa7f6444f663386931da049ae1d4753371b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004117ca0e802387afd18144f671579e694397d6fc3da8e5e050469c13440469a7727eda8d0083394693ac147e4c3d82aeb69bbe07cbb9d179be9687dbe4a123f1f71b00000000000000000000000000000000000000000000000000000000000000',
        value: '0',
      },
      metadata: {
        settlementLayers: ['ECO'],
        tokensOut: [
          {
            tokenAddress: '0xaf88d065e77c8cc2239327c5edb3a432268e5831',
            amount: '50000',
          },
        ],
      },
    },
    claims: [
      {
        call: {
          chainId: 8453,
          to: '0x000000000004598d17aad017bf0734a364c5588b',
          data: '0x0fbb12dc000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000014feebabe17996b3346cf80f04a1f072102a90cf0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000003bc9280836c0000000000679a258c64d2f20f310e12b64b7375ea6d13ac0000000000000000000000000000000000000000000000000000000000000040c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000006efb61d8c9546ff1b500de3f244ea7000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002c441bede0300000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000062b2ac83e0c8666d9be4e75b99c0e96c822d23e100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000005ad9ce1f5035fd62ca96cef16adaaf000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000764bb35b1c5000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007200000000000000000000000000f1a802ceffb3784b8999d06edba1a4edff9fbfa000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000006400000000000000000000000005eeb0df30c63390735645a0788a373550ebd57070000000000000000000000005eeb0df30c63390735645a0788a373550ebd57070ac5be7693d6687686ea2c5a08abbc12d71c2a685d07c3d982db0000000000000000000000000000000000000000000000000000000000000000000069093fe20000000000000000000000000000000000000000000000000000000069093fe20000000000000000000000000000000000000000000000000000000000002105000000000000000000000000000000000000000000000000000000000000a4b100000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000000000000000000000000000000000000000000001608d89211cc8954c170d5903833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000f2550000000000000000000000000000000000000000000000000000000000000001608d89211cc8954c170d5903af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000c350000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001420304000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001420304000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000062b2ac83e0c8666d9be4e75b99c0e96c822d23e1000000000000000000000000000000000000000000000000000000000000c350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014101c1d5521dc32115089d02774f5298df13dc71f000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000550000000000000000000000000000000000000000dc747d38e52808556101dd05e53ad363e7e7b2906431f2a1141daf86ca87a86e58cd169d3ca6da7ef9f8551cb819e84fa7f6444f663386931da049ae1d4753371b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
          value: '0',
        },
        beforeFill: true,
        metadata: {
          tokensIn: [
            {
              tokenAddress: '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913',
              amount: '62037',
            },
          ],
          settlementLayer: 'ECO',
        },
      },
    ],
    metadata: {
      dryRun: true,
      userAddress: '0x5eeb0df30c63390735645a0788a373550ebd5707',
    },
  },
  maxExecutionTime: 10000,
} as const;

const sourceChainId = 8453

const sampleClaim = sampleIntent.action.claims[0]

console.log('='.repeat(80))
console.log('STEP 1: Decode Adapter Claim')
console.log('='.repeat(80))

try {
  const claimData = decodeAdapterClaim(sampleClaim.call.data);

  console.log('\nüì¶ Decoded ClaimData:')
  console.log('  predictedVault:', claimData.predictedVault)
  console.log('\nüìã Order Details:')
  console.log('  sponsor:', claimData.order.sponsor)
  console.log('  recipient:', claimData.order.recipient)
  console.log('  nonce:', claimData.order.nonce.toString())
  console.log('  expires:', claimData.order.expires.toString())
  console.log('  fillDeadline:', claimData.order.fillDeadline.toString())
  console.log(
    '  notarizedChainId:',
    claimData.order.notarizedChainId.toString(),
  )
  console.log('  targetChainId:', claimData.order.targetChainId.toString())

  console.log('\nüí∞ Token In (reward):')
  claimData.order.tokenIn.forEach(([tokenId, amount], i) => {
    console.log(`  [${i}] tokenId: ${tokenId.toString()}`)
    console.log(`      amount: ${amount.toString()}`)
    // Convert tokenId to address
    const tokenAddress = `0x${tokenId.toString(16).padStart(40, '0').slice(-40)}`
    console.log(`      address: ${tokenAddress}`)
  })

  console.log('\nüí∏ Token Out (route):')
  claimData.order.tokenOut.forEach(([tokenId, amount], i) => {
    console.log(`  [${i}] tokenId: ${tokenId.toString()}`)
    console.log(`      amount: ${amount.toString()}`)
    // Convert tokenId to address
    const tokenAddress = `0x${tokenId.toString(16).padStart(40, '0').slice(-40)}`
    console.log(`      address: ${tokenAddress}`)
  })

  console.log('\nüîê Qualifier (contains portal + prover):')
  console.log('  Raw:', claimData.order.qualifier)
  console.log(
    '  Length:',
    claimData.order.qualifier.length,
    'chars (including 0x)',
  )

  // Manually decode qualifier
  const qualifierData = claimData.order.qualifier.slice(2)
  const inbox = '0x' + qualifierData.slice(0, 40)
  const prover = '0x' + qualifierData.slice(40, 80)
  const id = '0x' + qualifierData.slice(80, 144)

  console.log('\n  Decoded Qualifier:')
  console.log('    inbox (portal):', inbox)
  console.log('    prover:', prover)
  console.log('    id:', id)

  console.log('\n' + '='.repeat(80))
  console.log('STEP 2: Extract Intent from ClaimData')
  console.log('='.repeat(80))

  const claimHash = '0x' + '0'.repeat(64) // Dummy for testing
  // Use the portal address from the production data we analyzed
  const portal = '0x399dbd5df04f83103f77a58cba2b7c4d3cdede97' as `0x${string}`
  const intent = extractIntent(claimData, claimHash as Hex, sourceChainId, portal)

  console.log('\n‚úÖ Extracted Intent:')
  console.log('  intentHash:', intent.intentHash)
  console.log('  sourceChainId:', intent.sourceChainId.toString())
  console.log('  destination:', intent.destination.toString())
  console.log('\nüìç Route:')
  console.log('  portal:', intent.route.portal)
  console.log('  deadline:', intent.route.deadline.toString())
  console.log('  nativeAmount:', intent.route.nativeAmount.toString())
  console.log('  tokens:', intent.route.tokens.length)
  intent.route.tokens.forEach((t, i) => {
    console.log(`    [${i}] ${t.token} - ${t.amount.toString()}`)
  })

  console.log('\nüéÅ Reward:')
  console.log('  prover:', intent.reward.prover)
  console.log('  creator:', intent.reward.creator)
  console.log('  deadline:', intent.reward.deadline.toString())
  console.log('  nativeAmount:', intent.reward.nativeAmount.toString())
  console.log('  tokens:', intent.reward.tokens.length)
  intent.reward.tokens.forEach((t, i) => {
    console.log(`    [${i}] ${t.token} - ${t.amount.toString()}`)
  })

  console.log('\n' + '='.repeat(80))
  console.log('SUMMARY')
  console.log('='.repeat(80))

  // Denormalize addresses from UniversalAddress format to EVM format
  const denormalizedPortal = unpadFrom32Bytes(intent.route.portal).toLowerCase()
  const denormalizedProver = unpadFrom32Bytes(intent.reward.prover).toLowerCase()
  const denormalizedCreator = unpadFrom32Bytes(intent.reward.creator).toLowerCase()

  console.log('\nüì¶ Portal Address:')
  console.log('  UniversalAddress:', intent.route.portal)
  console.log('  Denormalized:    ', denormalizedPortal)
  console.log('  Expected:        ', '0x399dbd5df04f83103f77a58cba2b7c4d3cdede97')
  console.log('  Match:', denormalizedPortal === '0x399dbd5df04f83103f77a58cba2b7c4d3cdede97' ? '‚úÖ' : '‚ùå')

  console.log('\nüîê Prover Address:')
  console.log('  UniversalAddress:', intent.reward.prover)
  console.log('  Denormalized:    ', denormalizedProver)
  console.log('  From Qualifier:  ', '0x101c1d5521dc32115089d02774f5298df13dc71f')
  console.log('  Match:', denormalizedProver === '0x101c1d5521dc32115089d02774f5298df13dc71f' ? '‚úÖ' : '‚ùå')

  console.log('\nüë§ Creator Address:')
  console.log('  UniversalAddress:', intent.reward.creator)
  console.log('  Denormalized:    ', denormalizedCreator)
  console.log('  From Order:      ', claimData.order.sponsor.toLowerCase())
  console.log('  Match:', denormalizedCreator === claimData.order.sponsor.toLowerCase() ? '‚úÖ' : '‚ùå')
} catch (error) {
  console.error('‚ùå Error during decoding:', error)
  if (error instanceof Error) {
    console.error('Message:', error.message)
    console.error('Stack:', error.stack)
  }
}
